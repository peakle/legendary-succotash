<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTanks</title>
</head>

<body>
<div class="wrapper">
    <div class="progress-bar">
        <progress id="progress" value="0" max="100"></progress>
    </div>
    <span class="progress-text">Загрузка игры...</span>
    <span class="progress-text"
          style="font-size: 0.9em">(Может занять до минуты, есть время приготовить чай)</span>
</div>

<button title="Enter fullscreen" class="fullscreen_btn" onclick="fullscreen()"><img src="enlarge.svg"
                                                                                    alt="Enter fullscreen"></button>
</body>

<link rel="stylesheet" href="style.css">
<script src="wasm_exec.js"></script>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

<script>
    if (!WebAssembly.instantiateStreaming) {
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
            const source = await (await resp).arrayBuffer();
            return await WebAssembly.instantiate(source, importObject);
        };
    }

    function fullscreen() {
        let elem = document.documentElement;
        if (document.fullscreenElement) {
            document.exitFullscreen();
            return
        }

        elem.requestFullscreen();
    }

    function invitePopup(key) {
        vkBridge.send('VKWebAppShowInviteBox', {}).then((data) => {
            console.log("ладно", data.toString());
            return data.toString()
        }).catch((error) => {
            console.log("прохладно", error.toString());
            return error.toString()
        });
    }

    function wallPostPopup(msg, attachment) {
        vkBridge.send('VKWebAppShowWallPostBox', {
            message: msg,
            attachments: attachment
        }).then((data) => {
            console.log("ладно", data.toString());
            return data.toString()
        }).catch((error) => {
            console.log("прохладно", error.toString());
            return error.toString()
        });
    }

    function showBannerAd() {
        vkBridge.send('VKWebAppShowBannerAd', {
            banner_location: 'bottom'
        }).then((data) => {
            if (data.result) {
                console.log("ладно", data.result.toString());
                return data.result.toString();
            }
        }).catch((error) => {
            console.log("прохладно", error.toString());
            return error.toString();
        });
    }

    function hideBannerAd() {
        vkBridge.send('VKWebAppHideBannerAd', {
            banner_location: 'bottom'
        }).then((data) => {
            if (data.result) {
                console.log("ладно", data.toString());
                return data.toString();
            }
        }).catch((error) => {
            console.log("прохладно", error.toString());
            return error.toString();
        });
    }

    async function fetchWithProgress() {
        var response = await fetch('main.wasm');

        // Note - If you are compressing your .wasm file the Content-Length will be incorrect
        // One workaround is to use a custom http header to manually specify the uncompressed size
        var contentLength = response.headers.get('Content-Length');

        var total = parseInt(contentLength, 10) * 2;
        var loaded = 0;
        console.log("total:", total);
        let progressBar = document.getElementById('progress');

        function progressHandler(bytesLoaded, totalBytes) {
            progressBar.value = (bytesLoaded / totalBytes) * 100
        }

        var res = new Response(new ReadableStream({
            async start(controller) {
                var reader = response.body.getReader();
                for (; ;) {
                    var {done, value} = await reader.read();

                    if (done) {
                        progressHandler(total, total)
                        for (let element of document.getElementsByClassName("wrapper")) {
                            element.style.display = 'none'
                        }
                        break
                    }

                    loaded += value.byteLength;
                    progressHandler(loaded, total)
                    controller.enqueue(value);
                }
                console.log("loaded:", loaded);
                controller.close();
            },
        }, {
            "status": response.status,
            "statusText": response.statusText
        }));

        // Make sure to copy the headers!
        // Wasm is very picky with it's headers and it will fail to compile if they are not
        // specified correctly.
        for (var pair of response.headers.entries()) {
            res.headers.set(pair[0], pair[1]);
        }

        return res;
    }

    vkBridge.send('VKWebAppInit');
    showBannerAd();

    const go = new Go();
    WebAssembly.instantiateStreaming(fetchWithProgress(), go.importObject).then(result => {
        go.run(result.instance);
    });

    window.addEventListener("load", function () {
        document.body.focus();
    });
</script>
